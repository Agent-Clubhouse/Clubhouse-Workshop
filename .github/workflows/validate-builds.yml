name: Validate Plugin Builds

on:
  pull_request:
    paths:
      - 'plugins/*/src/**'
      - 'plugins/*/package.json'
      - 'plugins/*/tsconfig.json'
      - 'sdk/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Rebuild and check dist files
        run: |
          stale=""
          for plugin_dir in plugins/*/; do
            plugin=$(basename "$plugin_dir")
            if [ ! -f "$plugin_dir/package.json" ]; then
              continue
            fi

            echo "Building $plugin..."
            cd "$plugin_dir"
            npm install --ignore-scripts
            npm run build
            cd - > /dev/null

            if ! git diff --quiet "$plugin_dir/dist/"; then
              stale="$stale $plugin"
            fi
          done

          if [ -n "$stale" ]; then
            echo ""
            echo "ERROR: dist/ is out of date for:$stale"
            echo ""
            echo "Run 'npm run build' in each plugin directory and commit the updated dist files."
            exit 1
          fi

          echo "All dist files are up to date."

      - name: Validate plugin API versions
        run: |
          node -e "
            const fs = require('fs');
            const versions = JSON.parse(fs.readFileSync('sdk/versions.json', 'utf8'));
            let hasError = false;
            let hasWarning = false;

            for (const dir of fs.readdirSync('plugins')) {
              const manifestPath = 'plugins/' + dir + '/manifest.json';
              if (!fs.existsSync(manifestPath)) continue;
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              const api = String(manifest.engine?.api);
              const entry = versions.versions[api];

              if (!entry) {
                console.error('ERROR: ' + dir + ' targets unknown API version ' + api);
                hasError = true;
              } else if (entry.status === 'removed') {
                console.error('ERROR: ' + dir + ' targets removed API version ' + api);
                hasError = true;
              } else if (entry.status === 'deprecated') {
                console.warn('WARNING: ' + dir + ' targets deprecated API version ' + api + ' (removal target: ' + entry.removalTarget + ')');
                hasWarning = true;
              } else {
                console.log('OK: ' + dir + ' targets API v' + api + ' (' + entry.status + ')');
              }
            }

            if (hasError) process.exit(1);
            if (hasWarning) console.warn('\nSome plugins target deprecated API versions. Consider migrating with /migrate-plugin.');
          "
